name: GitHub Tiles
description: Generates SVGs for use with your GitHub profile

inputs:
  token:
    description: |
      GitHub token
      Generate a token via the link below and set 'Expiration' to 'No expiration'
      https://github.com/settings/tokens/new?scopes=repo,read:user&description=GitHub%20Tiles
      Save it into a GitHub actions secret called TOKEN
      Only pass via a GitHub action secret so it is masked
    required: true
  output:
    description: Output directory
    required: false
    default: assets
  tiles:
    description: "Tiles to generate (comma-separated: statistics,languages,contributions)"
    required: false
    default: statistics,languages,contributions
  private:
    description: Include private repositories
    required: false
    default: "false"
  forks:
    description: Include forked repositories
    required: false
    default: "false"
  languages-limit:
    description: Languages to display
    required: false
    default: "5"
  contributions-limit:
    description: Contributions to display
    required: false
    default: "10"
  contributions-min-stars:
    description: Contributions minimum stars
    required: false
    default: "0"
  opaque:
    description: Render opaque background
    required: false
    default: "false"
  optimize:
    description: SVG optimization
    required: false
    default: "true"
  log-level:
    description: Log level (error, warn, info, debug, trace)
    required: true
    default: info

runs:
  using: composite
  steps:
    - name: Checkout
      uses: actions/checkout@v6

    - name: Download binary
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        set -e
        VERSION="${{ github.action_ref }}"

        # If version is a major tag (v1, v2), find the latest matching release
        if [[ "$VERSION" =~ ^v[0-9]+$ ]]; then
          VERSION=$(gh release list --repo mbwilding/github-tiles --limit 100 \
            | grep -E "^${VERSION}\." \
            | head -1 \
            | cut -f3)
        fi

        # Fallback to latest release
        if [[ -z "$VERSION" ]]; then
          VERSION=$(gh release view --repo mbwilding/github-tiles --json tagName -q '.tagName')
        fi

        gh release download "$VERSION" \
          --repo mbwilding/github-tiles \
          --pattern "github-tiles" \
          --output github-tiles

        chmod +x github-tiles

    - name: Generate SVGs
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.token }}
        RUST_LOG: ${{ inputs.log-level }}
      run: |
        set -e
        ./github-tiles \
          --output "${{ inputs.output }}" \
          --tiles "${{ inputs.tiles }}" \
          --languages-limit "${{ inputs.languages-limit }}" \
          --contributions-limit "${{ inputs.contributions-limit }}" \
          --contributions-min-stars "${{ inputs.contributions-min-stars }}" \
          ${{ inputs.private == 'true' && '--private' || '' }} \
          ${{ inputs.forks == 'true' && '--forks' || '' }} \
          ${{ inputs.opaque == 'true' && '--opaque' || '' }} \
          ${{ inputs.optimize == 'true' && '--optimize' || '' }}

    - name: Delete binary
      if: always()
      shell: bash
      run: rm -f github-tiles

    - name: Commit
      shell: bash
      run: |
        git add "${{ inputs.output }}/*.svg"
        git config user.name "GitHub Tiles"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git commit -m "GitHub Tiles" || true
        git push
